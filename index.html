<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>MH Now 古龍記錄地圖</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <style>
    body, html { margin: 0; padding: 0; }
    #map { height: 100vh; }
    .leaflet-control-custom {
      background: white;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      font-size: 20px;
      width: 300px;
      box-sizing: border-box;
      border-radius: 8px;
    }
    .leaflet-control-custom .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .leaflet-control-custom button {
      flex: 1;
      font-size: 22px;
      padding: 14px;
      min-height: 56px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      cursor: pointer;
      transition: background 0.2s;
    }
    .leaflet-control-custom button:hover {
      background: #e0e0e0;
    }
    select[multiple] {
      width: 100%;
      font-size: 22px;
      padding: 10px;
      margin-bottom: 14px;
      border-radius: 6px;
    }
    @media (max-width: 600px) {
      .leaflet-control-custom {
        width: 100%;
        padding: 18px;
        font-size: 24px;
      }
      .leaflet-control-custom button {
        font-size: 28px;
        padding: 18px;
        min-height: 64px;
      }
      select[multiple], select, input[type="number"] {
        font-size: 28px;
        padding: 12px;
      }
    }
    .marker-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .marker-border {
      border-radius: 50%;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
    }
    .markerBorder {
      box-shadow: 0 0 0 6px red;
      border-radius: 50%;
      box-sizing: border-box;
    }
    #version, #zoomDisplay {
      position: absolute;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      font-size: 16px;
      border-radius: 4px;
      z-index: 1000;
    }
    #version { bottom: 10px; }
    #zoomDisplay { bottom: 40px; }
    .info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 260px;
      background: white;
      padding: 14px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      font-size: 20px;
      z-index: 1000;
    }
    .info-panel h3 {
      margin: 0 0 10px;
      font-size: 22px;
      border-bottom: 1px solid #ccc;
    }
    .info-panel p {
      margin: 10px 0;
    }
    .leaflet-popup-content { display: none; }
    #markerEditModal {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 30px 40px;
      z-index: 10000;
      box-shadow: 0 2px 15px rgba(0,0,0,0.4);
      border-radius: 10px;
      width: 260px;
      font-size: 20px;
      line-height: 1.5;
    }
    #markerEditModal h3 {
      margin-top: 0;
      font-size: 26px;
    }
    #markerEditModal select, #markerEditModal input {
      width: 100%;
      font-size: 22px;
      padding: 14px;
      margin-bottom: 14px;
      border-radius: 6px;
    }
    #markerEditModal button {
      font-size: 22px;
      padding: 14px 28px;
      min-height: 56px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      cursor: pointer;
      transition: background 0.2s;
    }
    #markerEditModal button:hover {
      background: #e0e0e0;
    }
    @media (max-width: 600px) {
      #markerEditModal {
        width: 90%;
        padding: 24px;
        font-size: 24px;
      }
      #markerEditModal h3 {
        font-size: 30px;
      }
      #markerEditModal select, #markerEditModal input {
        font-size: 28px;
        padding: 16px;
      }
      #markerEditModal button {
        font-size: 28px;
        padding: 18px 36px;
        min-height: 64px;
      }
    }
  </style>
</head>
<body>

<!-- 🟦 Marker 編輯用 Modal（顯示在左上角） -->
<div id="markerEditModal">
  <h3>更改標記資訊</h3>
  <label for="markerTime">時間：</label>
  <select id="markerTime">
    <!-- 由 JS 動態產生 -->
  </select><br><br>
  <label for="timePeriod">時間段：</label>
  <input type="text" id="timePeriod" readonly><br><br>
  <label for="markerType">顏色：</label>
  <select id="markerType">
    <option value="0">⚪ 原始</option>
    <option value="1">🔴 紅</option>
    <option value="2">🔵 藍</option>
    <option value="3">🟢 綠</option>
    <option value="4">🟣 紫</option>
  </select><br><br>
  <label for="markerRemark">狀態：</label>
  <select id="markerRemark">
    <!-- 由 JS 動態產生 -->
  </select><br><br>
  <div style="text-align:right;">
    <button id="saveMarkerBtn">儲存</button>
    <button onclick="
      document.getElementById('markerEditModal').style.display='none';
      const infoPanel = document.getElementById('infoPanel');
      if (infoPanel) infoPanel.style.display = '';
    ">取消</button>
  </div>
</div>

<div id="map"></div>
<div id="infoPanel" class="info-panel">
  <h3>標記資訊</h3>
  <div id="panelContent">請點選地圖上的標記</div>
</div>
<div id="version">版本 4.2.25</div>
<div id="zoomDisplay">Zoom: -</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// 所有時間表
const timeTableByTotalPoints = {
  1: ["06:15 07:05 07:55 08:45 09:35 10:25 11:15 12:05 12:55 13:45 14:35 15:25 16:15 17:05 17:55 18:45 19:35 20:25 21:15 22:05"],
  2: [
    "06:15 07:55 08:45 09:35 10:25 11:15 12:05 12:55 13:45 14:35 15:25 16:15 17:05 17:55 18:45 19:35 20:25 21:15 22:05 22:55",
    "06:40 08:20 09:10 10:00 10:50 11:40 12:30 13:20 14:10 15:00 15:50 16:40 17:30 18:20 19:10 20:00 20:50 21:40 22:30"
  ],
  3: [
    "06:15 08:45 11:15 13:45 16:15 18:45 21:15",
    "07:05 09:35 12:05 14:35 17:05 19:35 22:05",
    "07:55 10:25 12:55 15:25 17:55 20:25"
  ],
  4: [
    "06:15 07:55 09:35 11:15 12:55 14:35 16:15 17:55 19:35 21:15 22:55",
    "06:40 08:20 10:00 11:40 13:20 15:00 16:40 18:20 20:00 21:40 23:20",
    "07:05 08:45 10:25 12 revising: true;
    }
    this.updateMarkerScales();
  }

  clearAllMarkerBorders() {
    this.markers.eachLayer(marker => {
      const markerElement = marker.getElement();
      if (markerElement) {
        markerElement.classList.remove('markerBorder');
      }
    });
    this.selectedMarkers = [];
  }

  openGoogleRoute() {
    if (!this.selectedMarkers.length) {
      alert("請先選擇至少一個標記");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const current = `${position.coords.latitude},${position.coords.longitude}`;
        const waypoints = this.selectedMarkers.map(m => `${m.getLatLng().lat},${m.getLatLng().lng}`);
        const route = [current, ...waypoints];
        const url = `https://www.google.com/maps/dir/${route.join('/')}`;
        const link = document.createElement('a');
        link.href = url;
        link.target = '_blank';
        link.click();
      },
      () => alert('無法取得你的位置，請開啟定位權限')
    );
  }
}

document.addEventListener('DOMContentLoaded', function() {
  updateTimeOptionsForEdit(1, '');
});

const app = new MapApp();
</script>
</body>
</html>
