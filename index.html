<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>魔物地圖標記器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }

    .leaflet-control-layers-overlays label {
      font-size: 14px;
    }

    #infoPanel {
      position: absolute;
      right: 10px;
      top: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 8px;
      max-width: 250px;
      z-index: 999;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    #infoPanel h4 {
      margin: 0 0 5px 0;
    }

    #zoomDisplay {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 3px 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 999;
    }

    #version {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 3px 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 999;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="zoomDisplay">Zoom: -</div>
  <div id="version">版本 2.0.9</div>

  <!-- 固定右側面板 -->
  <div id="infoPanel">
    <h4>標記資訊</h4>
    <div id="infoContent">請點擊標記查看資訊</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    const markerColors = {
      elder: '古龍',
      rare: '稀有',
      normal: '普通'
    };

    class MapApp {
      constructor() {
        this.map = L.map('map').setView([25.04, 121.56], 13);
        this.editMode = false;
        this.routeSelecting = false;
        this.selectedMarkers = [];
        this.markers = L.layerGroup().addTo(this.map);
        this.infoContent = document.getElementById('infoContent');

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19
        }).addTo(this.map);

        this.map.on('click', (e) => {
          if (this.editMode) {
            const name = prompt("輸入標記名稱:");
            if (name) {
              const time = prompt("時間：", "09:00");
              const type = prompt("類型（elder, rare, normal）:", "normal");
              const remark = prompt("備註：", "");
              this.addMarker(e.latlng, { name, time, type, remark });
            }
          }
        });

        this.map.on('zoomend', () => {
          document.getElementById("zoomDisplay").innerText = "Zoom: " + this.map.getZoom();
        });

        this.loadMarkers();
      }

      getCustomIcon(type) {
        const color = {
          elder: 'purple',
          rare: 'gold',
          normal: 'blue'
        }[type] || 'gray';

        return L.divIcon({
          html: `<div style="background:${color}; width:12px; height:12px; border-radius:50%;"></div>`,
          className: '',
          iconSize: [12, 12]
        });
      }

      showInfoInPanel(marker) {
        const data = marker.data;
        const html = `
          <b>${data.name}</b><br>
          時間: ${data.time}<br>
          類型: ${markerColors[data.type] || '未指定'}<br>
          備註: ${data.remark}<br>
          ${this.editMode ? `<button onclick="app.deleteMarker('${marker._leaflet_id}')">🗑️ 刪除標記</button>` : ''}
        `;
        this.infoContent.innerHTML = html;
      }

      addMarker(latlng, data) {
        const marker = L.marker(latlng, {
          draggable: this.editMode,
          icon: this.getCustomIcon(data.type)
        });

        marker.data = data;
        marker.on('dragend', () => this.saveMarkers());
        marker.on('click', () => {
          if (this.editMode) {
            this.cycleMarkerColor(marker);
          } else if (this.routeSelecting) {
            if (this.selectedMarkers.includes(marker)) {
              this.selectedMarkers = this.selectedMarkers.filter(m => m !== marker);
              marker.setOpacity(1);
            } else {
              this.selectedMarkers.push(marker);
              marker.setOpacity(0.5);
            }
          } else {
            this.showInfoInPanel(marker);
          }
        });

        this.markers.addLayer(marker);
        this.saveMarkers();
      }

      cycleMarkerColor(marker) {
        const types = Object.keys(markerColors);
        const index = types.indexOf(marker.data.type);
        const nextType = types[(index + 1) % types.length];
        marker.data.type = nextType;
        marker.setIcon(this.getCustomIcon(nextType));
        this.saveMarkers();
      }

      deleteMarker(id) {
        this.markers.eachLayer(m => {
          if (m._leaflet_id == id) {
            this.markers.removeLayer(m);
          }
        });
        this.saveMarkers();
        this.infoContent.innerHTML = "請點擊標記查看資訊";
      }

      saveMarkers() {
        const data = [];
        this.markers.eachLayer(marker => {
          data.push({
            latlng: marker.getLatLng(),
            data: marker.data
          });
        });
        localStorage.setItem('mapMarkers', JSON.stringify(data));
      }

      loadMarkers() {
        const data = JSON.parse(localStorage.getItem('mapMarkers')) || [];
        data.forEach(item => this.addMarker(item.latlng, item.data));
      }
    }

    const app = new MapApp();
  </script>
</body>
</html>
