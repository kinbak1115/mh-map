<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>MH Now å¤é¾è¨˜éŒ„åœ°åœ– - è’²ç§</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; }
    #map { height: 100vh; }
    .leaflet-control-custom {
      background: white;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      font-size: 20px;
      width: 300px;
      box-sizing: border-box;
      border-radius: 8px;
    }
    .leaflet-control-custom .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .leaflet-control-custom button {
      flex: 1;
      font-size: 22px;
      padding: 14px;
      min-height: 56px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      cursor: pointer;
      transition: background 0.2s;
    }
    .leaflet-control-custom button:hover {
      background: #e0e0e0;
    }
    select[multiple] {
      width: 100%;
      font-size: 22px;
      padding: 10px;
      margin-bottom: 14px;
      border-radius: 6px;
    }
    @media (max-width: 600px) {
      .leaflet-control-custom {
        width: 100%;
        padding: 18px;
        font-size: 24px;
      }
      .leaflet-control-custom button {
        font-size: 28px;
        padding: 18px;
        min-height: 64px;
      }
      select[multiple], select, input[type="number"] {
        font-size: 28px;
        padding: 14px;
      }
    }
    .marker-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .marker-border {
      border-radius: 50%;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
    }
    .markerBorder {
      box-shadow: 0 0 0 6px red;
      border-radius: 50%;
      box-sizing: border-box;
    }
    #version, #zoomDisplay {
      position: absolute;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      font-size: 16px;
      border-radius: 5px;
      z-index: 1000;
    }
    #version { bottom: 10px; }
    #zoomDisplay { bottom: 40px; }
    .info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 260px;
      background: white;
      padding: 14px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      font-size: 20px;
      z-index: 1000;
    }
    .info-panel h3 {
      margin: 0 0 10px;
      font-size: 22px;
      border-bottom: 1px solid #ccc;
    }
    .info-panel p {
      margin: 10px 0;
    }
    .leaflet-popup-content { display: none; }
    #markerEditModal {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 30px 40px;
      z-index: 10000;
      box-shadow: 0 2px 15px rgba(0,0,0,0.4);
      border-radius: 10px;
      width: 260px;
      font-size: 20px;
      line-height: 1.5;
    }
    #markerEditModal h3 {
      margin-top: 0;
      font-size: 26px;
    }
    #markerEditModal select {
      width: 100%;
      font-size: 22px;
      padding: 14px;
      margin-bottom: 14px;
      border-radius: 6px;
    }
    #markerEditModal button {
      font-size: 22px;
      padding: 14px 28px;
      min-height: 56px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      cursor: pointer;
      transition: background 0.2s;
    }
    #markerEditModal button:hover {
      background: #e0e0e0;
    }
    #timePeriodDisplay {
      font-size: 20px;
      margin-bottom: 14px;
      color: #333;
    }
    @media (max-width: 600px) {
      #markerEditModal {
        width: 90%;
        padding: 24px;
        font-size: 24px;
      }
      #markerEditModal h3 {
        font-size: 30px;
      }
      #markerEditModal select {
        font-size: 28px;
        padding: 16px;
      }
      #markerEditModal button {
        font-size: 28px;
        padding: 18px 36px;
        min-height: 64px;
      }
      #timePeriodDisplay {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>

<!-- ğŸŸ¦ Marker ç·¨è¼¯ç”¨ Modalï¼ˆé¡¯ç¤ºåœ¨å·¦ä¸Šè§’ï¼‰ -->
<div id="markerEditModal">
  <h3>æ›´æ”¹æ¨™è¨˜è³‡è¨Š</h3>
  <label for="markerName">åç¨±ï¼š</label>
  <select id="markerName">
    <option value="å…¨å¤©å¤é¾ç¨®">å…¨å¤©å¤é¾ç¨®</option>
    <option value="ABABå¤é¾ç¨®">ABABå¤é¾ç¨®</option>
    <option value="BABAå¤é¾ç¨®">BABAå¤é¾ç¨®</option>
    <option value="å¤§é€£ç‹©çµ">å¤§é€£ç‹©çµ</option>
  </select><br/><br/>
  <label for="markerTime">æ™‚é–“ï¼š</label>
  <select id="markerTime">
    <!-- ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
  </select><br/>
  <div id="timePeriodDisplay">ç•¶å‰æ™‚æ®µï¼š-</div><br/>
  <label for="markerType">é¡è‰²ï¼š</label>
  <select id="markerType">
    <option value="0">âšª åŸå§‹</option>
    <option value="1">ğŸ”´ ç´…</option>
    <option value="2">ğŸ”µ è—</option>
    <option value="3">ğŸŸ¢ ç¶ </option>
    <option value="4">ğŸŸ£ ç´«</option>
  </select><br/><br/>
  <label for="markerRemark">ç‹€æ…‹ï¼š</label>
  <select id="markerRemark">
    <option value="Aç¢ºèª">Aç¢ºèª</option>
    <option value="Bç¢ºèª">Bç¢ºèª</option>
    <option value="ABç¢ºèª">ABç¢ºèª</option>
    <!-- å‹•æ…‹æ·»åŠ  remarkï¼ˆå¦‚ "f" é¡¯ç¤ºç‚º "ç„¡æ³•æ¥è§¸/ç„¡æ³•å¤é¾"ï¼‰ -->
  </select><br/><br/>
  <div style="text-align:right;">
    <button id="saveMarkerBtn">å„²å­˜</button>
    <button onclick="
      document.getElementById('markerEditModal').style.display='none';
      const infoPanel = document.getElementById('infoPanel');
      if (infoPanel) infoPanel.style.display = '';
    ">å–æ¶ˆ</button>
  </div>
</div>

<div id="map"></div>
<div id="infoPanel" class="info-panel">
  <h3>æ¨™è¨˜è³‡è¨Š</h3>
  <div id="panelContent">è«‹é»é¸åœ°åœ–ä¸Šçš„æ¨™è¨˜</div>
</div>
<div id="version">ç‰ˆæœ¬ 4.1.2</div>
<div id="zoomDisplay">Zoom: -</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// æ‰€æœ‰æ™‚é–“è¡¨
const timeTableByTotalPoints = {
  1: [
    "06:15 07:05 07:55 08:45 09:35 10:25 11:15 12:05 12:55 13:45 14:35 15:25 16:15 17:05 17:55 18:45 19:35 20:25 21:15 22:05",
  ],
  2: [
    "06:15 07:55 08:45 09:35 10:25 11:15 12:05 12:55 13:45 14:35 15:25 16:15 17:05 17:55 18:45 19:35 20:25 21:15 22:05 22:55",
    "06:40 08:20 09:10 10:00 10:50 11:40 12:30 13:20 14:10 15:00 15:50 16:40 17:30 18:20 19:10 20:00 20:50 21:40 22:30"
  ],
  3: [
    "06:15 08:45 11:15 13:45 16:15 18:45 21:15",
    "07:05 09:35 12:05 14:35 17:05 19:35 22:05",
    "07:55 10:25 12:55 15:25 17:55 20:25"
  ],
  4: [
    "06:15 07:55 09:35 11:15 12:55 14:35 16:15 17:55 19:35 21:15 22:55",
    "06:40 08:20 10:00 11:40 13:20 15:00 16:40 18:20 20:00 21:40 23:20",
    "07:05 08:45 10:25 12:05 13:45 15:25 17:05 18:45 20:25 22:05",
    "07:30 09:10 10:50 12:30 14:10 15:50 17:30 19:10 20:50 22:30"
  ],
  5: [
    "06:15 08:20 10:25 12:30 14:35 16:40 18:45 20:50 22:55",
    "06:40 08:45 10:50 12:55 15:00 17:05 19:10 21:15 23:20",
    "07:05 09:10 11:15 13:20 15:25 17:30 19:35 21:40",
    "07:30 09:35 11:40 13:45 15:50 17:55 20:00 22:05",
    "07:55 10:00 12:05 14:10 16:15 18:20 20:25 22:30"
  ],
  6: [
    "06:15 08:45 11:15 13:45 16:15 18:45 21:15",
    "06:40 09:10 11:40 14:10 16:40 19:10 21:40",
    "07:05 09:35 12:05 14:35 17:05 19:35 22:05",
    "07:30 10:00 12:30 15:00 17:30 20:00 22:30",
    "07:55 10:25 12:55 15:25 17:55 20:25 22:55",
    "08:20 10:50 13:20 15:50 18:20 20:50 23:20"
  ],
  7: [
    "06:15 08:45 11:15 13:45 16:15 18:45 21:15",
    "06:40 09:10 11:40 14:10 16:40 19:10 21:40",
    "07:05 09:35 12:05 14:35 17:05 19:35 22:05",
    "07:30 10:00 12:30 15:00 17:30 20:00 22:30",
    "07:55 10:25 12:55 15:25 17:55 20:25 22:55",
    "08:20 10:50 13:20 15:50 18:20 20:50 23:20"
  ],
  8: [
    "06:15 08:45 11:15 13:45 16:15 18:45 21:15",
    "06:40 09:10 11:40 14:10 16:40 19:10 21:40",
    "07:05 09:35 12:05 14:35 17:05 19:35 22:05",
    "07:30 10:00 12:30 15:00 17:30 20:00 22:30",
    "07:55 10:25 12:55 15:25 17:55 20:25 22:55",
    "08:20 10:50 13:20 15:50 18:20 20:50 23:20"
  ]
};

const markerColors = { 0: '', 1: 'red', 2: 'blue', 3: 'green', 4: 'purple' };

// æ‰€æœ‰38ç¨®æ™‚æ®µ
const allTimes = [
  "06:15", "06:40", "07:05", "07:30",
  "07:55", "08:20", "08:45", "09:10",
  "09:35", "10:00", "10:25", "10:50",
  "11:15", "11:40", "12:05", "12:30",
  "12:55", "13:20", "13:45", "14:10",
  "14:35", "15:00", "15:25", "15:50",
  "16:15", "16:40", "17:05", "17:30",
  "17:55", "18:20", "18:45", "19:10",
  "19:35", "20:00", "20:25", "20:50",
  "21:15", "21:40", "22:05", "22:30",
  "22:55", "23:20"
];

// === åˆ¤æ–·æ™‚é–“æ®µï¼ˆA/B/C ç­‰ï¼‰ ===
function getTimePeriodLabel(totalPoints, time) {
  if (!time || !timeTableByTotalPoints[totalPoints]) return '-';
  const timeTables = timeTableByTotalPoints[totalPoints];
  for (let i = 0; i < timeTables.length; i++) {
    if (timeTables[i] === time) {
      return String.fromCharCode(65 + i); // 0 -> A, 1 -> B, 2 -> C, ...
    }
  }
  return '-';
}

// === æ™‚é–“é¸é …ç”Ÿæˆ ===
function updateTimeOptionsForEdit(totalPoints, selectedTime) {
  const markerTime = document.getElementById('markerTime');
  markerTime.innerHTML = '';
  const arr = timeTableByTotalPoints[totalPoints] || [];
  arr.forEach(timestr => {
    const opt = document.createElement('option');
    opt.value = timestr;
    opt.textContent = timestr;
    markerTime.appendChild(opt);
  });
  if (totalPoints === 1 && arr.length === 1) {
    markerTime.value = arr[0];
  } else if (selectedTime) {
    markerTime.value = selectedTime;
  }
  // æ›´æ–°æ™‚æ®µé¡¯ç¤º
  const timePeriodDisplay = document.getElementById('timePeriodDisplay');
  timePeriodDisplay.textContent = `ç•¶å‰æ™‚æ®µï¼š${getTimePeriodLabel(totalPoints, markerTime.value)}`;
}

// === æ›´æ–° remark é¸é … ===
function updateRemarkOptionsForEdit(remark) {
  const markerRemark = document.getElementById('markerRemark');
  const defaultOptions = ['Aç¢ºèª', 'Bç¢ºèª', 'ABç¢ºèª'];
  markerRemark.innerHTML = '';

  // æ·»åŠ é»˜è®¤é€‰é¡¹
  defaultOptions.forEach(optValue => {
    const opt = document.createElement('option');
    opt.value = optValue;
    opt.textContent = optValue;
    markerRemark.appendChild(opt);
  });

  // å¦‚æœ remark ä¸º "f"ï¼Œæ·»åŠ é€‰é¡¹æ˜¾ç¤ºä¸ºâ€œç„¡æ³•æ¥è§¸/ç„¡æ³•å¤é¾â€ï¼Œå€¼ä»ä¸º "f"
  if (remark === 'f') {
    const opt = document.createElement('option');
    opt.value = 'f';
    opt.textContent = 'ç„¡æ³•æ¥è§¸/ç„¡æ³•å¤é¾';
    markerRemark.appendChild(opt);
  } else if (remark && !defaultOptions.includes(remark)) {
    // å…¶ä»–éé»˜è®¤é€‰é¡¹ï¼ŒåŸæ ·æ˜¾ç¤º
    const opt = document.createElement('option');
    opt.value = remark;
    opt.textContent = remark;
    markerRemark.appendChild(opt);
  }

  // è®¾ç½®å½“å‰ remark å€¼
  markerRemark.value = remark || defaultOptions[0];
}

// é¸æ“‡æœ€è¿‘çš„å…ˆå‰æ™‚é–“
function getNearestTimeString(marker) {
  let times = (marker.data.time || "").split(/\s+/).filter(Boolean);
  if (!times.length) return "";

  const now = new Date();
  const nowMin = now.getHours() * 60 + now.getMinutes();

  let minDiff = Infinity;
  let bestDisplayTime = "";

  for (const t of times) {
    const m = t.match(/(\d{1,2}):(\d{2})/);
    if (!m) continue;
    const h = parseInt(m[1], 10);
    const mm = parseInt(m[2], 10);
    const total = h * 60 + mm;
    let diff = nowMin - total;
    if (diff < -12 * 60) diff += 24 * 60;
    if (diff >= 0 && diff < minDiff) {
      minDiff = diff;
      bestDisplayTime = t;
    }
  }

  return bestDisplayTime;
}

class MapApp {
  constructor() {
    this.map = L.map('map', {
      doubleClickZoom: false
    });
    this.map.locate({ setView: true, maxZoom: 16 });

    this.map.on('locationfound', e => {
      let maxRadius = 100;
      let r = Math.min(e.accuracy / 2, maxRadius);
      L.circle(e.latlng, {
        radius: r,
        color: 'blue',
        fillOpacity: 0.2
      }).addTo(this.map);
    });

    this.map.on('locationerror', () => {
      alert("ç„¡æ³•å–å¾—ä½ çš„å®šä½ï¼Œä½¿ç”¨é è¨­åœ°é»ã€‚");
      this.map.setView([3.0000, 101.6167], 14);
    });

    this.markers = new L.FeatureGroup();
    this.filteredTypes = [];
    this.lastMarkerType = 0;
    this.routeSelecting = false;
    this.selectedMarkers = [];
    this.currentMode = "done"; // ç¢ºä¿åˆå§‹æ¨¡å¼ç‚º done

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: 'Â© <a href="https://carto.com/">CARTO</a>'
    }).addTo(this.map);
    this.markers.addTo(this.map);

    this.initControls();
    this.loadSavedMarkers();
    this.initEventListeners();

    this.map.on('zoomend', () => this.updateMarkerScales());
    this.updateMarkerScales();

    setInterval(() => this.updateMarkerScales(), 60 * 1000);
  }

  initControls() {
    const control = L.control({ position: 'topright' });
    control.onAdd = () => {
      const div = L.DomUtil.create('div', 'leaflet-control-custom');
      div.innerHTML = `
        <div class="btn-row">
          <button onclick="app.toggleEditMode()" id="editBtn">é–‹å§‹ç·¨è¼¯</button>
          <button onclick="app.deleteSelectedMarker()">ğŸ—‘ï¸ åˆªé™¤æ¨™è¨˜</button>
        </div>
        <label>é¡¯ç¤ºé¡è‰²ï¼š</label>
        <select id="filterSelect" multiple size="5" onchange="app.filterMarkersByTypes()">
          <option value="0">âšª åŸå§‹</option>
          <option value="1">ğŸ”´ ç´…</option>
          <option value="2">ğŸ”µ è—</option>
          <option value="3">ğŸŸ¢ ç¶ </option>
          <option value="4">ğŸŸ£ ç´«</option>
        </select>
        <div class="btn-row">
          <button onclick="app.confirmImportFromGitHub()">ğŸŒ åŒ¯å…¥ GitHub æ¨™è¨˜</button>
        </div>
        <div class="btn-row">
          <button onclick="app.toggleSelectingRoute()" id="routeBtn">é¸æ“‡è·¯ç·š</button>
          <button onclick="app.openGoogleRoute()">ğŸ—ºï¸ Google åœ°åœ–è·¯ç·š</button>
        </div>
      `;
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    control.addTo(this.map);
  }

  updateInfoPanel(data) {
    // å°† remark "f" æ˜¾ç¤ºä¸ºâ€œç„¡æ³•æ¥è§¸/ç„¡æ³•å¤é¾â€
    const displayRemark = data.remark === 'f' ? 'ç„¡æ³•æ¥è§¸/ç„¡æ³•å¤é¾' : (data.remark || '');
    const content = `
      <p><strong>${data.name}</strong></p>
      <p>æ™‚é–“ï¼š${data.time}</p>
      <p>é¡å‹ï¼š${markerColors[data.type] || 'åŸå§‹'}</p>
      <p>å‚™è¨»ï¼š${displayRemark}</p>
      <p>åº§æ¨™ï¼š${data.lat ? data.lat.toFixed(6) : ""}, ${data.lng ? data.lng.toFixed(6) : ""}</p>
      <p>åœ°åœ–ç·¨è™Ÿï¼š${data.mapId !== undefined ? data.mapId : ""}</p>
      <p>åœ°å›¾æ€»é‡‡é›†ç‚¹ï¼š${data.totalPoints !== undefined ? data.totalPoints : ""}</p>
    `;
    document.getElementById('panelContent').innerHTML = content;
  }

  initEventListeners() {
    // ç§»é™¤æ‰‹åŠ¨æ·»åŠ æ ‡è®°çš„ç‚¹å‡»/è§¦æ‘¸äº‹ä»¶ç›‘å¬
  }

  getCustomIcon(type = 0, scale = 1, marker = null, orderNumber = null) {
    const iconUrl = 'https://raw.githubusercontent.com/kinbak1115/mh-map/refs/heads/main/gather.png';
    const iconUrls = {
      0: iconUrl,
      1: 'https://raw.githubusercontent.com/kinbak1115/mh-map/refs/heads/main/redelder.png',
      2: 'https://raw.githubusercontent.com/kinbak1115/mh-map/refs/heads/main/blueelder.png',
      3: 'https://raw.githubusercontent.com/kinbak1115/mh-map/refs/heads/main/greenelder.png',
      4: 'https://raw.githubusercontent.com/kinbak1115/mh-map/refs/heads/main/elder.png',
      raid: 'https://raw.githubusercontent.com/kinbak1115/mh-map/refs/heads/main/raid.png'
    };

    let useIconUrl = iconUrls[type];
    let isRaid = false;
    if (marker && marker.data && marker.data.name === "å¤§é€£ç‹©çµ") {
      useIconUrl = iconUrls.raid;
      isRaid = true;
    }

    let size = 40 * scale;
    if (isRaid) {
      size = size * 0.75;
    }

    let timeStr = "";
    if (marker) {
      if (!(marker.data && marker.data.name === "å¤§é€£ç‹©çµ")) {
        timeStr = getNearestTimeString(marker);
      }
    }

    let timeFontSize = Math.max(10, Math.floor(14 * scale));

    let showRedCross = marker && marker.data && typeof marker.data.remark === 'string' && marker.data.remark.toLowerCase().includes('f');

    const redCrossSVG = `
      <svg width="${size}" height="${size}" style="position:absolute;top:0;left:0;pointer-events:none;z-index:11;" viewBox="0 0 ${size} ${size}">
        <line x1="6" y1="6" x2="${size-6}" y2="${size-6}" stroke="rgba(255,0,0,0.3)" stroke-width="6" stroke-linecap="round"/>
        <line x1="${size-6}" y1="6" x2="6" y2="${size-6}" stroke="rgba(255,0,0,0.3)" stroke-width="6" stroke-linecap="round"/>
      </svg>
    `;

    return L.divIcon({
      className: '',
      html: `
        <div class="marker-wrapper" style="position:relative;">
          <div class="marker-border" style="
            background-image: url('${useIconUrl}');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: ${size}px;
            height: ${size}px;
            position: relative;
          ">
            ${showRedCross ? redCrossSVG : ""}
            ${timeStr ? `<div style="position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.75);color:#fff;font-size:${timeFontSize}px;padding:2px 8px;border-radius:4px;white-space:nowrap;">${timeStr}</div>` : ""}
            ${orderNumber !== null ? `
              <div class="marker-order-badge" style="
                position: absolute;
                top: ${-10 * scale}px;
                left: ${-10 * scale}px;
                width: ${Math.max(20 * scale, 18)}px;
                height: ${Math.max(20 * scale, 18)}px;
                background: #ff6600;
                color: #fff;
                border-radius: 50%;
                font-size: ${Math.max(11 * scale, 12)}px;
                font-weight: bold;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                border: ${2 * scale}px solid #fff;
                z-index: 20;
              ">${orderNumber+1}</div>
            ` : ""}
          </div>
        </div>`,
      iconSize: [size, size],
      iconAnchor: [size / 2, size / 2],
      popupAnchor: [0, -size / 2]
    });
  }

  isMobile() {
    return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
  }

  updateMarkerScales() {
    const zoom = this.map.getZoom();
    const mobile = this.isMobile();
    let scale = 1.0;
    if (mobile) { 
      if (zoom >= 18) scale = 2.0;
      else if (zoom === 17) scale = 1.6;
      else if (zoom === 16) scale = 1.2;
      else if (zoom === 15) scale = 1.0;
      else if (zoom === 14) scale = 0.6;
      else scale = 0.3;
    } else {
      if (zoom >= 18) scale = 1.0;
      else if (zoom === 17) scale = 0.9;
      else if (zoom === 16) scale = 0.8;
      else if (zoom === 15) scale = 0.5;
      else if (zoom === 14) scale = 0.3;
      else scale = 0.3;
    }
    this.markers.eachLayer(marker => {
      let orderNumber = null;
      if (this.routeSelecting) {
        const idx = this.selectedMarkers.indexOf(marker);
        if (idx !== -1) orderNumber = idx;
      }
      marker.setIcon(this.getCustomIcon(marker.data.type, scale, marker, orderNumber));
      const el = marker.getElement();
      if (el && this.selectedMarkers.includes(marker)) {
        el.classList.add('markerBorder');
      }
    });
    document.getElementById('zoomDisplay').textContent = `Zoom: ${zoom}`;
  }

  addMarker(latlng, data) {
    if (!data.totalPoints) data.totalPoints = 1;
    if (!data.mapId) data.mapId = 1;
    if (!data.remark) data.remark = ''; // ç¢ºä¿ remark æœ‰å€¼ï¼Œå…è¨±ç©ºå­—ä¸²æˆ– "f"
    const marker = L.marker(latlng, {
      icon: this.getCustomIcon(data.type, 1, { data }),
      draggable: false
    });
    marker.data = data;
    this.resetAllMarkers();

    const handler = (e) => {
      e.preventDefault(); // é˜²æ­¢è§¸æ§è¨­å‚™ä¸Šçš„é è¨­è¡Œç‚º
      console.log('Marker clicked, currentMode:', this.currentMode); // èª¿è©¦æ—¥èªŒ
      this.selectedMarker = marker;
      if (this.routeSelecting) {
        const markerElement = marker.getElement();
        if (this.selectedMarkers.includes(marker)) {
          this.selectedMarkers = this.selectedMarkers.filter(m => m !== marker);
          if (markerElement) markerElement.classList.remove('markerBorder');
        } else {
          this.selectedMarkers.push(marker);
          if (markerElement) markerElement.classList.add('markerBorder');
        }
        this.updateMarkerScales();
        return;
      }
      if (this.currentMode === "editMarker") {
        this.resetAllMarkers();
        marker.setOpacity(1.0);
        marker.setZIndexOffset(1000);
        const infoPanel = document.getElementById('infoPanel');
        if (infoPanel) infoPanel.style.display = 'none';
        document.getElementById('markerName').value = marker.data.name;
        updateTimeOptionsForEdit(marker.data.totalPoints || 1, marker.data.time);
        document.getElementById('markerType').value = marker.data.type;
        updateRemarkOptionsForEdit(marker.data.remark);
        // å‹•æ…‹æ›´æ–°æ™‚æ®µé¡¯ç¤º
        document.getElementById('markerTime').onchange = () => {
          const timePeriodDisplay = document.getElementById('timePeriodDisplay');
          timePeriodDisplay.textContent = `ç•¶å‰æ™‚æ®µï¼š${getTimePeriodLabel(marker.data.totalPoints, document.getElementById('markerTime').value)}`;
        };
        const modal = document.getElementById('markerEditModal');
        if (modal) {
          console.log('Showing modal'); // èª¿è©¦æ—¥èªŒ
          modal.style.display = 'block';
        } else {
          console.error('Modal element not found'); // èª¿è©¦æ—¥èªŒ
        }
        document.getElementById('saveMarkerBtn').onclick = () => {
          const name = document.getElementById('markerName').value.trim();
          const time = document.getElementById('markerTime').value;
          const type = Math.min(Math.max(parseInt(document.getElementById('markerType').value) || 0, 0), 4);
          const remark = document.getElementById('markerRemark').value.trim();
          marker.data.name = name;
          marker.data.time = time;
          marker.data.type = type;
          marker.data.remark = remark; // ä¿å­˜ç”¨æˆ¶é¸æ“‡çš„ remarkï¼ˆåŒ…æ‹¬ "f"ï¼‰
          marker.setIcon(this.getCustomIcon(type, 1, marker));

          this.autoAssignTimeForRelatedMarkers(marker);

          this.updateMarkerScales();
          this.saveMarkers();
          this.updateInfoPanel(marker.data);
          if (infoPanel) infoPanel.style.display = '';
          modal.style.display = 'none';
        };
      } else {
        this.resetAllMarkers();
        marker.setOpacity(1.0);
        marker.setZIndexOffset(1000);
        this.updateInfoPanel(marker.data);
      }
    };
    marker.on('click', handler);
    marker.on('touchstart', handler);
    this.selectedMarker = marker;
    this.markers.addLayer(marker);
    this.saveMarkers();
    this.filterMarkersByTypes();
    this.updateMarkerScales();
  }

  resetAllMarkers() {
    this.markers.eachLayer(m => {
      m.setOpacity(0.6);
      m.setZIndexOffset(0);
    });
  }

  autoAssignTimeForRelatedMarkers(marker) {
    const totalPoints = marker.data.totalPoints;
    if (![2, 3, 4, 5, 6].includes(totalPoints)) return;

    const selectedTime = marker.data.time;
    const selectedMapId = marker.data.mapId;
    const timeOptions = timeTableByTotalPoints[totalPoints];
    const selectedTimeIndex = timeOptions.indexOf(selectedTime);

    if (selectedTimeIndex === -1) {
      console.warn('Invalid time selected for marker:', selectedTime);
      return;
    }

    let relatedMarkers = [];
    this.markers.eachLayer(m => {
      if (m !== marker && m.data.mapId === selectedMapId && m.data.totalPoints === totalPoints) {
        relatedMarkers.push(m);
      }
    });

    const maxRelated = totalPoints - 1;
    if (relatedMarkers.length > maxRelated) {
      alert(`è­¦å‘Šï¼šæ‰¾åˆ°å¤šå€‹å…·æœ‰ç›¸åŒ mapId å’Œ totalPoints=${totalPoints} çš„æ¨™è¨˜ï¼Œåªæ›´æ–°å‰ ${maxRelated} å€‹ã€‚`);
      relatedMarkers = relatedMarkers.slice(0, maxRelated);
    }

    const usedIndices = [selectedTimeIndex];
    relatedMarkers.forEach(m => {
      const idx = timeOptions.indexOf(m.data.time);
      if (idx !== -1) usedIndices.push(idx);
    });

    if (usedIndices.length >= maxRelated && relatedMarkers.length >= maxRelated) {
      const availableIndices = Array.from({ length: timeOptions.length }, (_, i) => i).filter(i => !usedIndices.includes(i));
      if (availableIndices.length > 0) {
        const nthMarker = relatedMarkers.find(m => !usedIndices.includes(timeOptions.indexOf(m.data.time)) || timeOptions.indexOf(m.data.time) === -1) || 
                         relatedMarkers[relatedMarkers.length - 1];
        if (nthMarker) {
          nthMarker.data.time = timeOptions[availableIndices[0]];
          nthMarker.setIcon(this.getCustomIcon(nthMarker.data.type, 1, nthMarker));
          if (this.selectedMarker === nthMarker) {
            this.updateInfoPanel(nthMarker.data);
          }
        }
      }
    }
  }

  deleteSelectedMarker() {
    if (!this.selectedMarker) {
      alert('è«‹å…ˆé»é¸ä¸€å€‹æ¨™è¨˜å†åˆªé™¤');
      return;
    }
    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ¨™è¨˜ï¼Ÿ')) {
      this.markers.removeLayer(this.selectedMarker);
      this.saveMarkers();
      this.selectedMarker = null;
      document.getElementById('panelContent').innerText = 'è«‹é»é¸åœ°åœ–ä¸Šçš„æ¨™è¨˜';
    }
  }

  saveMarkers() {
    const saved = [];
    this.markers.eachLayer(marker => saved.push({ ...marker.data, lat: marker.getLatLng().lat, lng: marker.getLatLng().lng }));
    localStorage.setItem('mhnow_markers', JSON.stringify(saved));
  }

  loadSavedMarkers() {
    this.markers.clearLayers();
    const saved = JSON.parse(localStorage.getItem('mhnow_markers') || '[]');
    saved.forEach(data => {
      if (data.totalPoints === 1) {
        data.time = timeTableByTotalPoints[1][0];
      }
      this.addMarker(L.latLng(data.lat, data.lng), data);
    });
    this.updateMarkerScales();
  }

  filterMarkersByTypes() {
    const selected = Array.from(document.getElementById('filterSelect').selectedOptions)
                         .map(opt => parseInt(opt.value));
    const types = selected.length ? selected : [0, 1, 2, 3, 4];
    this.markers.eachLayer(marker => {
      const icon = marker._icon;
      if (icon) {
        icon.style.visibility = types.includes(marker.data.type) ? 'visible' : 'hidden';
      }
    });
    this.filteredTypes = types;
  }

  confirmImportFromGitHub() {
    if (confirm('ç¢ºå®šå¾ GitHub åŒ¯å…¥æ¨™è¨˜ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰æ¨™è¨˜ã€‚')) {
      if (confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦å¾ GitHub åŒ¯å…¥ä¸¦è¦†è“‹ï¼Ÿ')) {
        this.importFromGitHub();
     Ã©nek

    }
  }

  importFromGitHub() {
    const url = 'https://raw.githubusercontent.com/kinbak1115/mh-map/main/mhnow_backup_2025-05-12.json';
    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data)) throw new Error();
        localStorage.setItem('mhnow_markers', JSON.stringify(data));
        alert('æˆåŠŸå¾ GitHub åŒ¯å…¥æ¨™è¨˜ï¼Œé‡æ–°è¼‰å…¥åœ°åœ–ã€‚');
        location.reload();
      })
      .catch(() => alert('GitHub åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆé€£çµèˆ‡æ ¼å¼ã€‚'));
  }

  toggleEditMode() {
    if (this.routeSelecting) {
      this.clearAllMarkerBorders();
      this.routeSelecting = false;
      const routeBtn = document.getElementById('routeBtn');
      if (routeBtn) routeBtn.textContent = 'é¸æ“‡è·¯ç·š';
    }
    if (this.currentMode === "done") {
      this.currentMode = "editMarker";
      document.getElementById('editBtn').textContent = "çµæŸç·¨è¼¯";
      console.log('Switched to editMarker mode'); // èª¿è©¦æ—¥èªŒ
    } else {
      this.currentMode = "done";
      document.getElementById('editBtn').textContent = "é–‹å§‹ç·¨è¼¯";
      this.saveMarkers();
      document.getElementById('markerEditModal').style.display = 'none';
      const infoPanel = document.getElementById('infoPanel');
      if (infoPanel) infoPanel.style.display = '';
      console.log('Switched to done mode'); // èª¿è©¦æ—¥èªŒ
    }
    this.updateMarkerScales();
  }

  toggleSelectingRoute() {
    this.routeSelecting = !this.routeSelecting;
    const button = document.getElementById('routeBtn');
    if (this.routeSelecting) {
      if (this.currentMode !== 'done') {
        this.currentMode = 'done';
        const editBtn = document.getElementById('editBtn');
        if (editBtn) editBtn.textContent = 'é–‹å§‹ç·¨è¼¯';
        document.getElementById('markerEditModal').style.display = 'none';
        const infoPanel = document.getElementById('infoPanel');
        if (infoPanel) infoPanel.style.display = '';
      }
      this.selectedMarkers = [];
      button.textContent = 'å®Œæˆé¸æ“‡';
      this.resetAllMarkers();
    } else {
      this.clearAllMarkerBorders();
      button.textContent = 'é¸æ“‡è·¯ç·š';
    }
    this.updateMarkerScales();
  }

  clearAllMarkerBorders() {
    this.markers.eachLayer(marker => {
      const markerElement = marker.getElement();
      if (markerElement) {
        markerElement.classList.remove('markerBorder');
      }
    });
    this.selectedMarkers = [];
  }

  openGoogleRoute() {
    if (!this.selectedMarkers.length) {
      alert("è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹æ¨™è¨˜");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const current = `${position.coords.latitude},${position.coords.longitude}`;
        const waypoints = this.selectedMarkers.map(m => `${m.getLatLng().lat},${m.getLatLng().lng}`);
        const route = [current, ...waypoints];
        const url = `https://www.google.com/maps/dir/${route.join('/')}`;
        const link = document.createElement('a');
        link.href = url;
        link.target = '_blank';
        link.click();
      },
      () => alert('ç„¡æ³•å–å¾—ä½ çš„ä½ç½®ï¼Œè«‹é–‹å•Ÿå®šä½æ¬Šé™')
    );
  }
}

document.addEventListener('DOMContentLoaded', function() {
  updateTimeOptionsForEdit(1, '');
});

const app = new MapApp();
</script>
</body>
</html>
