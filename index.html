<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MH Now å¤é¾è¨˜éŒ„åœ°åœ– - è’²ç§</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 100vh; }
        .leaflet-control-custom {
            padding: 10px;
            background: white;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            font-size: 14px;
            line-height: 1.5;
        }
        select[multiple] {
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const markerColors = {
            1: { color: 'red',    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png' },
            2: { color: 'blue',   iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png' },
            3: { color: 'green',  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png' },
            4: { color: 'orange', iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png' }
        };

        class MapApp {
            constructor() {
                this.map = L.map('map');
this.map.locate({ setView: true, maxZoom: 16 });

this.map.on('locationfound', (e) => {
    L.circle(e.latlng, {
        radius: e.accuracy / 2,
        color: 'blue',
        fillOpacity: 0.2
    }).addTo(this.map);
});

this.map.on('locationerror', (e) => {
    alert("ç„¡æ³•å–å¾—ä½ çš„å®šä½ï¼Œä½¿ç”¨é è¨­åœ°é»ã€‚");
    this.map.setView([3.0000, 101.6167], 14);
});

                this.markers = new L.FeatureGroup();
                this.filteredTypes = [];

                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://carto.com/">CARTO</a>'
}).addTo(this.map);
                this.markers.addTo(this.map);

                this.initControls();
                this.loadSavedMarkers();
                this.initEventListeners();
            }

            initControls() {
                const control = L.control({ position: 'topright' });
                control.onAdd = () => {
                    const div = L.DomUtil.create('div', 'leaflet-control-custom');
                    div.innerHTML = `
                        <button onclick="app.toggleEditMode()" id="editBtn">æ–°å¢æ¨™è¨˜</button><br><br>
                        <label>é¡¯ç¤ºé¡è‰²ï¼š</label><br>
                        <select id="filterSelect" multiple onchange="app.filterMarkersByTypes()">
                            <option value="1">ğŸ”´ ç´…</option>
                            <option value="2">ğŸ”µ è—</option>
                            <option value="3">ğŸŸ¢ ç¶ </option>
                            <option value="4">ğŸŸ  æ©™</option>
                        </select>
                    `;
                    return div;
                };
                control.addTo(this.map);
            }

            toggleEditMode() {
                this.editMode = !this.editMode;
                document.getElementById('editBtn').textContent = this.editMode ? 'å®Œæˆç·¨è¼¯' : 'æ–°å¢æ¨™è¨˜';
            }

            initEventListeners() {
                this.map.on('click', (e) => {
                    if (this.editMode) {
                        this.showMarkerForm(e.latlng);
                    }
                });
            }

            getCustomIcon(type = 1) {
                return L.icon({
                    iconUrl: markerColors[type].iconUrl,
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                });
            }

            showMarkerForm(latlng) {
                const input = prompt(
                    'è¼¸å…¥å¤é¾è³‡è¨Šï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰:\næ ¼å¼ï¼šåç¨±, æ™‚é–“, é¡å‹(1-4), å‚™è¨»\né¡è‰²é¡å‹ï¼š1=ç´… 2=è— 3=ç¶  4=æ©™',
                    'å¤é¾ç¨®, ç¾åœ¨, 1, é‡è¦å‡ºæ²’é»'
                );
                if (input) {
                    const [name, time, type, remark] = input.split(',').map(s => s.trim());
                    const markerType = Math.min(Math.max(parseInt(type) || 1, 1), 4);
                    this.addMarker(latlng, { name, time, type: markerType, remark });
                }
            }

            addMarker(latlng, data) {
                const marker = L.marker(latlng, {
                    draggable: true,
                    icon: this.getCustomIcon(data.type)
                }).bindPopup(this.getPopupContent(data, latlng));

                marker.data = data;
                marker.on('dragend', () => this.saveMarkers());
                this.markers.addLayer(marker);
                this.saveMarkers();
                this.filterMarkersByTypes(); // ç¢ºä¿æ·»åŠ å¾Œå¥—ç”¨ç¯©é¸
            }

            getPopupContent(data, latlng) {
                return `
                    <b style="color:${markerColors[data.type].color}">${data.name}</b><br>
                    æ™‚é–“: ${data.time}<br>
                    é¡å‹: ${markerColors[data.type].color}<br>
                    å‚™è¨»: ${data.remark}<br>
                    <button onclick='app.editMarker(${JSON.stringify({...data, latlng})})'>ç·¨è¼¯</button>
                    <button onclick='app.deleteMarker(this)'>åˆªé™¤</button>
                `;
            }

            editMarker(oldData) {
                const input = prompt(
                    'ç·¨è¼¯è³‡è¨Šï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰:\næ ¼å¼ï¼šåç¨±, æ™‚é–“, é¡å‹(1-4), å‚™è¨»',
                    `${oldData.name}, ${oldData.time}, ${oldData.type}, ${oldData.remark}`
                );
                if (input) {
                    const [name, time, type, remark] = input.split(',').map(s => s.trim());
                    const markerType = Math.min(Math.max(parseInt(type) || 1, 1), 4);

                    this.markers.eachLayer(marker => {
                        if (marker.data.name === oldData.name &&
                            marker.getLatLng().toString() === L.latLng(oldData.latlng).toString()) {
                            marker.setIcon(this.getCustomIcon(markerType));
                            marker.setPopupContent(this.getPopupContent(
                                { name, time, type: markerType, remark },
                                marker.getLatLng()
                            ));
                            marker.data = { name, time, type: markerType, remark };
                            this.saveMarkers();
                            this.filterMarkersByTypes();
                        }
                    });
                }
            }

            deleteMarker(button) {
    const popup = button.closest('.leaflet-popup-content');
    const name = popup.querySelector('b').textContent;

    // å–å¾—ç›®å‰ popup ç¶å®šçš„ marker ä½ç½®
    const popupElement = button.closest('.leaflet-popup');
    const markerLatLng = app.map._popup._source.getLatLng();

    this.markers.eachLayer(marker => {
        if (
            marker.data.name === name &&
            marker.getLatLng().toString() === markerLatLng.toString()
        ) {
            this.markers.removeLayer(marker);
        }
    });
    this.saveMarkers();


            }

            saveMarkers() {
                const saved = [];
                this.markers.eachLayer(marker => {
                    saved.push({
                        lat: marker.getLatLng().lat,
                        lng: marker.getLatLng().lng,
                        ...marker.data
                    });
                });
                localStorage.setItem('mhnow_markers', JSON.stringify(saved));
            }

            loadSavedMarkers() {
                const saved = JSON.parse(localStorage.getItem('mhnow_markers') || '[]');
                saved.forEach(item => {
                    this.addMarker([item.lat, item.lng], item);
                });
            }

            filterMarkersByTypes() {
                const select = document.getElementById('filterSelect');
                const selectedTypes = Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
                this.filteredTypes = selectedTypes;

                this.markers.eachLayer(marker => {
                    const shouldShow = (selectedTypes.length === 0 || selectedTypes.includes(marker.data.type));
                    if (shouldShow) {
                        marker.addTo(this.map);
                    } else {
                        this.map.removeLayer(marker);
                    }
                });
            }
        }

        const app = new MapApp();
    </script>
</body>
</html>
