<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>MH Now 古龍記錄地圖 - 蒲种</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    body, html { margin: 0; padding: 0; }
    #map { height: 100vh; }
    /* ...原有樣式省略... */

    /* 新增地區標籤樣式 */
    .area-label {
      pointer-events: auto;
      font-size: 20px;
      font-weight: bold;
      background: #ffe066;
      color: #222;
      padding: 5px 12px;
      border-radius: 8px;
      border: 2px solid #eab308;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: inline-block;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <!-- ...原有側欄與標記編輯 Modal 省略... -->
  <div id="map"></div>
  <div id="infoPanel" class="info-panel">
    <h3>標記資訊</h3>
    <div id="panelContent">請點選地圖上的標記</div>
  </div>
  <div id="version">版本 3.4.1</div>
  <div id="zoomDisplay">Zoom: -</div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script>
    // ...原有工具函數略...

    class MapApp {
      constructor() {
        this.map = L.map('map', {
          doubleClickZoom: false
        });
        this.map.locate({ setView: true, maxZoom: 16 });

        // ...原有 locationfound/locationerror/tiles/markers...

        this.markers = new L.FeatureGroup();
        this.areaMarkers = new L.FeatureGroup();
        this.drawnItems = new L.FeatureGroup();
        this.filteredTypes = [];
        this.lastMarkerType = 0;
        this.routeSelecting = false;
        this.selectedMarkers = [];

        this.markers.addTo(this.map);
        this.areaMarkers.addTo(this.map);
        this.drawnItems.addTo(this.map);

        // 加入 Leaflet.draw 工具列
        this.drawControl = new L.Control.Draw({
          edit: { featureGroup: this.drawnItems },
          draw: {
            polygon: true,
            rectangle: true,
            circle: false,
            marker: false,
            polyline: false,
            circlemarker: false
          }
        });
        this.map.addControl(this.drawControl);

        // 畫完多邊形時
        this.map.on(L.Draw.Event.CREATED, (e) => {
          const layer = e.layer;
          const name = prompt('請輸入區域名稱');
          if (name) {
            layer.bindTooltip(name, { permanent: true, direction: 'center' }).openTooltip();
            layer.feature = { properties: { name } }; // for saving
            this.drawnItems.addLayer(layer);
            this.saveMarkers();
          }
        });

        // 編輯多邊形時同步儲存
        this.map.on(L.Draw.Event.EDITED, (e) => {
          this.saveMarkers();
        });
        this.map.on(L.Draw.Event.DELETED, (e) => {
          this.saveMarkers();
        });

        this.initControls();
        this.loadSavedMarkers();
        this.initEventListeners();

        this.map.on('zoomend', () => this.updateMarkerScales());
        this.updateMarkerScales();
        setInterval(() => this.updateMarkerScales(), 60 * 1000);
      }

      // ...原有 marker/area 控制略...

      saveMarkers() {
        const saved = [];
        this.markers.eachLayer(marker => saved.push({ ...marker.data, lat: marker.getLatLng().lat, lng: marker.getLatLng().lng }));
        this.areaMarkers.eachLayer(marker => saved.push({ ...marker.data, lat: marker.getLatLng().lat, lng: marker.getLatLng().lng }));
        localStorage.setItem('mhnow_markers', JSON.stringify(saved));
        // 加入多邊形儲存
        const geojson = this.drawnItems.toGeoJSON();
        localStorage.setItem('mhnow_areas', JSON.stringify(geojson));
      }

      loadSavedMarkers() {
        this.markers.clearLayers();
        this.areaMarkers.clearLayers();

        // 載入標記
        const saved = JSON.parse(localStorage.getItem('mhnow_markers') || '[]');
        saved.forEach(data => {
          if (data.type === 'area') {
            this.addAreaMarker(L.latLng(data.lat, data.lng), data.areaName);
          } else {
            this.addMarker(L.latLng(data.lat, data.lng), data);
          }
        });

        // 載入多邊形
        this.drawnItems.clearLayers();
        const geojson = JSON.parse(localStorage.getItem('mhnow_areas') || '{"type":"FeatureCollection","features":[]}');
        L.geoJSON(geojson, {
          onEachFeature: (feature, layer) => {
            const name = feature.properties && feature.properties.name;
            if (name) layer.bindTooltip(name, { permanent: true, direction: 'center' }).openTooltip();
            this.drawnItems.addLayer(layer);
          }
        });
      }
      
      filterMarkersByTypes() {
        const selected = Array.from(document.getElementById('filterSelect').selectedOptions)
                              .map(opt => parseInt(opt.value));
        const types = selected.length ? selected : [0, 1, 2, 3, 4];
        this.markers.eachLayer(marker => {
          const icon = marker._icon;
          if (icon) {
            icon.style.visibility = types.includes(marker.data.type) ? 'visible' : 'hidden';
          }
        });
        // 地區標記總是顯示
        this.filteredTypes = types;
      }

      backupMarkers() {
        const data = JSON.stringify(
          [
            ...this.markers.getLayers().map(marker => marker.data),
            ...this.areaMarkers.getLayers().map(marker => marker.data)
          ]
        );
        const blob = new Blob([data], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'markers_backup.json';
        link.click();
      }

      restoreMarkers() {
        document.getElementById('restoreFile').click();
      }

      confirmImportFromGitHub() {
        if (confirm('確定從 GitHub 匯入標記？這將覆蓋現有標記。')) {
          if (confirm('再次確認：真的要從 GitHub 匯入並覆蓋？')) {
            this.importFromGitHub();
          }
        }
      }

      importFromGitHub() {
        const url = 'https://raw.githubusercontent.com/kinbak1115/mh-map/main/mhnow_backup_2025-05-12.json';
        fetch(url)
          .then(res => res.json())
          .then(data => {
            if (!Array.isArray(data)) throw new Error();
            localStorage.setItem('mhnow_markers', JSON.stringify(data));
            alert('成功從 GitHub 匯入標記，重新載入地圖。');
            location.reload();
          })
          .catch(() => alert('GitHub 匯入失敗，請檢查檔案連結與格式。'));
      }

      toggleEditMode() {
        if (this.routeSelecting) {
          app.clearAllMarkerBorders();
          this.routeSelecting = false;
          const routeBtn = document.getElementById('routeBtn');
          if (routeBtn) routeBtn.textContent = '選擇路線';
        }
        if (this.currentMode === "done") {
          this.currentMode = "editMarker";
          document.getElementById('editBtn').textContent = "結束編輯";
          this.markers.eachLayer(marker => marker.dragging.enable());
          this.areaMarkers.eachLayer(marker => marker.dragging && marker.dragging.enable());
        } else {
          this.currentMode = "done";
          document.getElementById('editBtn').textContent = "開始編輯";
          this.markers.eachLayer(marker => marker.dragging.disable());
          this.areaMarkers.eachLayer(marker => marker.dragging && marker.dragging.disable());
          this.saveMarkers();
        }
        this.updateMarkerScales();
      }

      toggleSelectingRoute() {
        this.routeSelecting = !this.routeSelecting;
        const button = document.getElementById('routeBtn');
        if (this.routeSelecting) {
          if (this.currentMode !== 'done') {
            this.currentMode = 'done';
            const editBtn = document.getElementById('editBtn');
            if (editBtn) editBtn.textContent = '開始編輯';
            this.markers.eachLayer(marker => marker.dragging.disable());
            this.areaMarkers.eachLayer(marker => marker.dragging && marker.dragging.disable());
          }
          this.selectedMarkers = [];
          button.textContent = '完成選擇';
          this.resetAllMarkers();
        } else {
          app.clearAllMarkerBorders();
          button.textContent = '選擇路線';
        }
        this.updateMarkerScales();
      }

      clearAllMarkerBorders() {
        this.markers.eachLayer(marker => {
          const markerElement = marker.getElement();
          if (markerElement) {
            markerElement.classList.remove('markerBorder');
          }
        });
        this.selectedMarkers = [];
      }

      openGoogleRoute() {
        if (!this.selectedMarkers.length) {
          alert("請先選擇至少一個標記");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const current = `${position.coords.latitude},${position.coords.longitude}`;
            const waypoints = this.selectedMarkers.map(m => `${m.getLatLng().lat},${m.getLatLng().lng}`);
            const route = [current, ...waypoints];
            const url = `https://www.google.com/maps/dir/${route.join('/')}`;
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.click();
          },
          () => alert('無法取得你的位置，請開啟定位權限')
        );
      }
    }

    const app = new MapApp();
  </script>
</body>
</html>
