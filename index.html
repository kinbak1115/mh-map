<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>MH Now å¤é¾è¨˜éŒ„åœ°åœ– - è’²ç§</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .leaflet-control-custom {
      padding: 10px;
      background: white;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      font-size: 14px;
      line-height: 1.5;
      width: 220px;
    }
    button {
      font-size: 16px;
      padding: 10px;
      margin: 4px 0;
      width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
const iconUrl = 'https://raw.githubusercontent.com/kinbak1115/mh-map/refs/heads/main/elder.png';
const markerColors = ['transparent', 'red', 'blue', 'green'];

const map = L.map('map').setView([3.0000, 101.6167], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let allMarkers = [];
let selectedMarkers = [];
let selectionMode = false;
let selectionCircles = [];

function getCustomIcon(colorIndex = 0) {
  const borderColor = markerColors[colorIndex] || 'transparent';
  return L.divIcon({
    className: '',
    html: `<div style="
      width: 32px; height: 32px;
      border: 4px solid ${borderColor};
      border-radius: 50%;
      background: url('${iconUrl}') center/cover no-repeat;
    "></div>`,
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  });
}

function createMarker(lat, lng, name, colorIndex = 0) {
  const marker = L.marker([lat, lng], {
    icon: getCustomIcon(colorIndex)
  }).addTo(map);

  marker.data = { lat, lng, name };
  marker.on('click', () => {
    if (!selectionMode) return;

    const isSelected = selectedMarkers.includes(marker);
    if (isSelected) {
      selectedMarkers = selectedMarkers.filter(m => m !== marker);
      removeCircleForMarker(marker);
    } else {
      selectedMarkers.push(marker);
      drawCircleForMarker(marker);
    }
  });

  marker.bindPopup(name);
  allMarkers.push(marker);
}

function drawCircleForMarker(marker) {
  const latlng = marker.getLatLng();
  const circle = L.circle(latlng, {
    radius: 20,
    color: 'yellow',
    weight: 4,
    fillOpacity: 0
  }).addTo(map);
  circle._marker = marker;
  selectionCircles.push(circle);
}

function removeCircleForMarker(marker) {
  const target = selectionCircles.find(c => c._marker === marker);
  if (target) {
    map.removeLayer(target);
    selectionCircles = selectionCircles.filter(c => c !== target);
  }
}

function startOrFinishSelection(btn) {
  selectionMode = !selectionMode;
  btn.textContent = selectionMode ? 'å®Œæˆé¸æ“‡' : 'é–‹å§‹é¸æ“‡è·¯ç·š';

  if (!selectionMode) {
    console.log('é¸å–å®Œæˆï¼Œå…±é¸æ“‡ ' + selectedMarkers.length + ' å€‹åœ°é»');
  }
}

function openRouteInGoogleMaps() {
  if (selectedMarkers.length < 2) {
    alert('è«‹é¸æ“‡è‡³å°‘å…©å€‹åœ°é»ã€‚');
    return;
  }

  if (!navigator.geolocation) {
    alert('ç„¡æ³•ç²å–ç›®å‰ä½ç½®ã€‚');
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const origin = `${pos.coords.latitude},${pos.coords.longitude}`;
    const waypoints = selectedMarkers.map(m => `${m.getLatLng().lat},${m.getLatLng().lng}`);
    const destination = waypoints.pop();
    const waypointsStr = waypoints.length > 0 ? '&waypoints=' + waypoints.join('|') : '';
    const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypointsStr}&travelmode=walking`;

    window.open(url, '_blank');
  }, () => {
    alert('å®šä½å¤±æ•—ï¼Œç„¡æ³•è¦åŠƒè·¯ç·šã€‚');
  });
}

// å»ºç«‹æ§åˆ¶é¢æ¿
L.control.custom = function() {
  const control = L.control({ position: 'topright' });
  control.onAdd = function() {
    const div = L.DomUtil.create('div', 'leaflet-control-custom');
    div.innerHTML = `
      <button id="selectRouteBtn">é–‹å§‹é¸æ“‡è·¯ç·š</button>
      <button onclick="openRouteInGoogleMaps()">ğŸ“ è¦åŠƒè·¯ç·š</button>
    `;
    setTimeout(() => {
      document.getElementById('selectRouteBtn').onclick = function() {
        startOrFinishSelection(this);
      };
    }, 0);
    return div;
  };
  return control;
};
L.control.custom().addTo(map);

// ç¯„ä¾‹åœ°é»ï¼ˆå¯è‡ªè¡Œæ›´æ›ï¼‰
createMarker(3.0001, 101.6165, 'åœ°é» A', 1);
createMarker(3.0003, 101.6167, 'åœ°é» B', 2);
createMarker(3.0005, 101.6169, 'åœ°é» C', 3);
</script>
</body>
</html>
