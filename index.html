<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>MH NOW 地圖標記</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .leaflet-popup-content {
      text-align: center;
    }
    .leaflet-popup-content button {
      margin-top: 5px;
    }
    #controls {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      z-index: 1000;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      font-family: sans-serif;
    }
    #controls button {
      margin: 5px;
    }
  </style>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-sA+e2b65TbTzMmuHt8zPU06XZ9mYBSt6JfPzYolP8+0="
    crossorigin=""
  />
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <button onclick="mapApp.exportMarkers()">導出 JSON</button>
    <button onclick="mapApp.importFromGitHub()">從 GitHub 匯入</button>
    <button onclick="mapApp.clearMarkers()">清除所有標記</button>
  </div>
  <script
    src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-CcEJXkM5IyzvOkA6Y5kKFnhjZXrVZkC2U3r2YyPtkVY="
    crossorigin=""
  ></script>
  <script>
    class MapApp {
      constructor() {
        this.map = L.map("map").setView([25.0478, 121.5319], 13); // 台北為預設中心
        this.markers = [];

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> 貢獻者',
        }).addTo(this.map);

        this.map.on("click", this.onMapClick.bind(this));
        this.loadMarkers();
      }

      onMapClick(e) {
        const latlng = e.latlng;
        const name = prompt("輸入魔物名稱：");
        if (name) {
          const marker = this.addMarker(latlng, name);
          this.saveMarker(marker);
        }
      }

      addMarker(latlng, name) {
        const marker = L.marker(latlng)
          .addTo(this.map)
          .bindPopup(`<b>${name}</b><br><button onclick="mapApp.removeMarker(${latlng.lat}, ${latlng.lng})">刪除</button>`);
        marker.name = name;
        marker.latlng = latlng;
        this.markers.push(marker);
        return marker;
      }

      removeMarker(lat, lng) {
        const index = this.markers.findIndex(
          (m) => m.latlng.lat === lat && m.latlng.lng === lng
        );
        if (index !== -1) {
          this.map.removeLayer(this.markers[index]);
          this.markers.splice(index, 1);
          this.saveAllMarkers();
        }
      }

      saveMarker(marker) {
        const markerData = {
          name: marker.name,
          lat: marker.latlng.lat,
          lng: marker.latlng.lng,
        };
        const savedMarkers = JSON.parse(localStorage.getItem("mhnow_markers")) || [];
        savedMarkers.push(markerData);
        localStorage.setItem("mhnow_markers", JSON.stringify(savedMarkers));
      }

      saveAllMarkers() {
        const markerData = this.markers.map((m) => ({
          name: m.name,
          lat: m.latlng.lat,
          lng: m.latlng.lng,
        }));
        localStorage.setItem("mhnow_markers", JSON.stringify(markerData));
      }

      loadMarkers() {
        const savedMarkers = JSON.parse(localStorage.getItem("mhnow_markers")) || [];
        savedMarkers.forEach((m) => {
          this.addMarker({ lat: m.lat, lng: m.lng }, m.name);
        });
      }

      exportMarkers() {
        const dataStr = JSON.stringify(this.markers.map((m) => ({
          name: m.name,
          lat: m.latlng.lat,
          lng: m.latlng.lng,
        })), null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "mhnow_markers.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      importFromGitHub() {
        const url = "https://raw.githubusercontent.com/kinbak1115/mh-map/main/mhnow_backup_2025-05-12.json";
        fetch(url)
          .then(res => res.json())
          .then(data => {
            localStorage.setItem("mhnow_markers", JSON.stringify(data));
            alert("匯入完成，將重新載入地圖。");
            location.reload();
          })
          .catch(err => {
            console.error("匯入失敗:", err);
            alert("匯入失敗，請稍後再試。");
          });
      }

      clearMarkers() {
        if (confirm("確定要清除所有標記？此操作無法還原。")) {
          this.markers.forEach((m) => this.map.removeLayer(m));
          this.markers = [];
          localStorage.removeItem("mhnow_markers");
        }
      }
    }

    const mapApp = new MapApp();
  </script>
</body>
</html>
